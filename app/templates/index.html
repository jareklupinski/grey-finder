{% extends "base.html" %}

{% block content %}
<div style="text-align: center;">
    <h1>Hi, {{ current_user.username }}!</h1>
    
    <form action = "/upload" method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        {{ form.csvFile() }}
        {{ form.submit() }}
    </form>

    Filters:
    <form>
        <input id="smallButton" onclick="reloadItems();" type="radio" name="dimensions" value="100">Small</input>
        <input id="mediumButton" onclick="reloadItems();" type="radio" name="dimensions" value="200">Medium</input>
        <input id="largeButton" onclick="reloadItems();" type="radio" name="dimensions" value="300">Large</input>
        <input id="allButton" onclick="reloadItems();" type="radio" name="dimensions" value="0">All</input>
        <input id="greyscaleButton" onclick="reloadItems();" type="checkbox" name="greyscale" value="1">Greyscale</input>
    </form>

    <nav class="navbar navbar-light bg-light sticky-top">
        <div class="container">
            <a class="navbar-brand" id="loaded" href="#">0 items loaded</a>
        </div>
    </nav>

    <div id="container">
        <template id="image_template">
            <img id="content"/>
        </template>
    </div>

    <div id="sentinel">
        <div role="status"></div>
    </div>
    
</div>
<script>
    var scroller = document.querySelector("#container");
    var template = document.querySelector('#image_template');
    var loaded = document.querySelector("#loaded");
    var sentinel = document.querySelector('#sentinel');
    var counter = 0;
    var barVisible = 0;
    function loadItems() {
        var dimensions = 0
        var ele = document.getElementsByName('dimensions');      
        for(i = 0; i < ele.length; i++) { 
            if(ele[i].checked) 
                dimensions = ele[i].value; 
        } 

        var greyscale = ""
        if (document.getElementById('greyscaleButton').checked) {
            greyscale = "&greyscale"
        }
        fetch(`/api/pictures?start=${counter}&dimensions=${dimensions}${greyscale}`).then((response) => {
            response.json().then((data) => {
                if (!data.length) {
                    sentinel.innerHTML = "No more pictures!";
                    return;
                }
                for (var i = 0; i < data.length; i++) {
                    let template_clone = template.content.cloneNode(true);
                    template_clone.querySelector("#content").src = "static/" + data[i]['url'];
                    scroller.appendChild(template_clone);
                    counter += 1;
                    loaded.innerText = `${counter} items loaded`;
                }
            })
        })
    }
    
    function reloadItems() {
        while (scroller.firstChild) {
            scroller.removeChild(scroller.firstChild);
        }
        counter = 0;
        if (barVisible) {
            loadItems();
        }
    }
    
    var intersectionObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            console.log(entry.intersectionRatio);
            barVisible = entry.intersectionRatio;
        })
        if (entries[0].intersectionRatio <= 0) {
            return;
        }
        loadItems();
    });
    
    // Instruct the IntersectionObserver to watch the sentinel
    intersectionObserver.observe(sentinel);
</script>
{% endblock %}